x-rnode: &default-rnode
  image: f1r3flyindustries/f1r3fly-scala-node
  user: root
  networks:
    - f1r3fly
  environment:
    - OPENAI_ENABLED=${OPENAI_ENABLED:-false}
    - OPENAI_SCALA_CLIENT_API_KEY=${OPENAI_SCALA_CLIENT_API_KEY:-}

services:
  boot:
    <<: *default-rnode
    container_name: ${BOOTSTRAP_HOST}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        BOOTSTRAP_NODE_ID=$$(cat /var/lib/rnode/validator-keys/node_id.txt)
        exec /opt/docker/bin/rnode \
          -Dlogback.configurationFile=/var/lib/rnode/logback.xml \
          run \
          -c /var/lib/rnode/rnode.conf \
          --host=${BOOTSTRAP_HOST} \
          --allow-private-addresses \
          --bootstrap="rnode://$$BOOTSTRAP_NODE_ID@${BOOTSTRAP_HOST}?protocol=40400&discovery=40404"
    ports:
      - "40400:40400"
      - "40401:40401"
      - "40402:40402"
      - "40403:40403"
      - "40404:40404"
      - "40405:40405"
    volumes:
      # Persistent data directory (MUST BE FIRST)
      - ./data/bootstrap:/var/lib/rnode
      # Bootstrap-specific configuration (ceremony master)
      - ./conf/bootstrap-ceremony.conf:/var/lib/rnode/rnode.conf
      - ./genesis/wallets.txt:/var/lib/rnode/genesis/wallets.txt
      - ./genesis/bonds.txt:/var/lib/rnode/genesis/bonds.txt
      - ./conf/logback.xml:/var/lib/rnode/logback.xml
      # Validator keys (includes blockchain keys and TLS certificates)
      - ./keys/bootstrap:/var/lib/rnode/validator-keys:ro

  validator1:
    <<: *default-rnode
    container_name: ${VALIDATOR1_HOST}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        BOOTSTRAP_NODE_ID=$$(cat /var/lib/rnode/bootstrap-node-id/node_id.txt)
        exec /opt/docker/bin/rnode \
          -Dlogback.configurationFile=/var/lib/rnode/logback.xml \
          run \
          -c /var/lib/rnode/rnode.conf \
          --host=${VALIDATOR1_HOST} \
          --allow-private-addresses \
          --bootstrap="rnode://$$BOOTSTRAP_NODE_ID@${BOOTSTRAP_HOST}?protocol=40400&discovery=40404" \
          --genesis-validator
    ports:
      - "40410:40400"
      - "40411:40401"
      - "40412:40402"
      - "40413:40403"
      - "40414:40404"
      - "40415:40405"
    volumes:
      # Persistent data directory (MUST BE FIRST)
      - ./data/validator1:/var/lib/rnode
      - ./conf/shared-rnode.conf:/var/lib/rnode/rnode.conf
      - ./genesis/wallets.txt:/var/lib/rnode/genesis/wallets.txt
      - ./genesis/bonds.txt:/var/lib/rnode/genesis/bonds.txt
      - ./conf/logback.xml:/var/lib/rnode/logback.xml
      # Validator keys (includes blockchain keys and TLS certificates)
      - ./keys/validator1:/var/lib/rnode/validator-keys:ro
      - ./keys/bootstrap/node_id.txt:/var/lib/rnode/bootstrap-node-id/node_id.txt:ro

  validator2:
    <<: *default-rnode
    container_name: ${VALIDATOR2_HOST}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        BOOTSTRAP_NODE_ID=$$(cat /var/lib/rnode/bootstrap-node-id/node_id.txt)
        exec /opt/docker/bin/rnode \
          -Dlogback.configurationFile=/var/lib/rnode/logback.xml \
          run \
          -c /var/lib/rnode/rnode.conf \
          --host=${VALIDATOR2_HOST} \
          --allow-private-addresses \
          --bootstrap="rnode://$$BOOTSTRAP_NODE_ID@${BOOTSTRAP_HOST}?protocol=40400&discovery=40404" \
          --genesis-validator
    ports:
      - "40420:40400"
      - "40421:40401"
      - "40422:40402"
      - "40423:40403"
      - "40424:40404"
      - "40425:40405"
    volumes:
      # Persistent data directory (MUST BE FIRST)
      - ./data/validator2:/var/lib/rnode
      - ./conf/shared-rnode.conf:/var/lib/rnode/rnode.conf
      - ./genesis/wallets.txt:/var/lib/rnode/genesis/wallets.txt
      - ./genesis/bonds.txt:/var/lib/rnode/genesis/bonds.txt
      - ./conf/logback.xml:/var/lib/rnode/logback.xml
      # Validator keys (includes blockchain keys and TLS certificates)
      - ./keys/validator2:/var/lib/rnode/validator-keys:ro
      - ./keys/bootstrap/node_id.txt:/var/lib/rnode/bootstrap-node-id/node_id.txt:ro

  validator3:
    <<: *default-rnode
    container_name: ${VALIDATOR3_HOST}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        BOOTSTRAP_NODE_ID=$$(cat /var/lib/rnode/bootstrap-node-id/node_id.txt)
        exec /opt/docker/bin/rnode \
          -Dlogback.configurationFile=/var/lib/rnode/logback.xml \
          run \
          -c /var/lib/rnode/rnode.conf \
          --host=${VALIDATOR3_HOST} \
          --allow-private-addresses \
          --bootstrap="rnode://$$BOOTSTRAP_NODE_ID@${BOOTSTRAP_HOST}?protocol=40400&discovery=40404" \
          --genesis-validator
    ports:
      - "40430:40400"
      - "40431:40401"
      - "40432:40402"
      - "40433:40403"
      - "40434:40404"
      - "40435:40405"
    volumes:
      # Persistent data directory (MUST BE FIRST)
      - ./data/validator3:/var/lib/rnode
      - ./conf/shared-rnode.conf:/var/lib/rnode/rnode.conf
      - ./genesis/wallets.txt:/var/lib/rnode/genesis/wallets.txt
      - ./genesis/bonds.txt:/var/lib/rnode/genesis/bonds.txt
      - ./conf/logback.xml:/var/lib/rnode/logback.xml
      # Validator keys (includes blockchain keys and TLS certificates)
      - ./keys/validator3:/var/lib/rnode/validator-keys:ro
      - ./keys/bootstrap/node_id.txt:/var/lib/rnode/bootstrap-node-id/node_id.txt:ro

  # =================================================================
  # AUTOPROPOSE SERVICE - RChain-Inspired Continuous Block Proposing
  # =================================================================
  autopropose:
    build: ./autopropose
    container_name: autopropose
    restart: unless-stopped
    networks:
      - f1r3fly
    volumes:
      # Configuration files
      - ./autopropose/config.yml:/app/config.yml:ro
      # Contract files for deployment
      - ./resources:/contracts:ro
      # Optional: logs directory
      - ./logs:/var/log
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=UTC
    # Wait for validators to be ready before starting autopropose
    depends_on:
      - boot
      - validator1
      - validator2
      - validator3
    # Health check to ensure service is running
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    # Optional: monitoring port (uncomment if monitoring enabled in config)
    # ports:
    #   - "8080:8080"

networks:
  f1r3fly:
    driver: bridge 
